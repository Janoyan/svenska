<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio Practice App</title>
    <style>
        .correct {
            background-color: #d4ff5e;
        }

        .incorrect {
            background-color: #f3a5a5;
        }

        body {
            font-family: sans-serif;
            margin: auto;
            padding: 20px;
        }

        input {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            font-size: 1em;
        }

        button {
            padding: 10px 20px;
            font-size: 1em;
        }

        .hidden {
            display: none;
        }

        .mistake {
            margin-bottom: 10px;
            background: #ffe0e0;
            padding: 10px;
        }
    </style>
</head>
<body>
<h1>Audio Practice</h1>
<p id="stepInfo">Loading...</p>
<audio id="audio" controls></audio>
<form id="answerForm" class="hidden">
    <label>
        English:
        <input type="text" id="textInput" required>
    </label>
    <button type="submit">Next</button>
</form>

<div id="results" class="hidden">
    <h2>✅ Completed!</h2>
    <p id="score"></p>
    <h3>Mistakes:</h3>
    <div id="mistakeList"></div>
</div>

<script>
    const AMOUNT = 25;
    const DATA_URL = `./jsons/current.json?nocache=${Date.now()}`;
    const answerForm = document.getElementById('answerForm');
    const textInput = document.getElementById('textInput');
    const audioEl = document.getElementById('audio');
    const stepInfo = document.getElementById('stepInfo');
    const resultsDiv = document.getElementById('results');
    const scoreEl = document.getElementById('score');
    const mistakeList = document.getElementById('mistakeList');

    let tasks = [];
    let currentIndex = 0;
    let userAnswers = [];
    const taskAttemptCount = new Map();
    const skipMap = new Set();

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function loadTask(index) {
        const task = tasks[index];
        const key = task.id;

        const attempts = taskAttemptCount.get(key);
        if (skipMap.has(key)) {
            // Already marked to skip; auto-fill remaining attempts with 'x'
            while (attempts.length < 4) {
                attempts.push('x');
                userAnswers.push({ task, userText: 'x' });
            }
            goToNextTask();
            return;
        }

        audioEl.src = task.audio;
        audioEl.play();
        textInput.value = "";
        stepInfo.textContent = `Step ${index + 1} of ${tasks.length}`;
        textInput.focus();
    }

    function goToNextTask() {
        currentIndex++;
        if (currentIndex < tasks.length) {
            loadTask(currentIndex);
        } else {
            showResults();
        }
    }

    function showResults() {
        answerForm.classList.add('hidden');
        audioEl.classList.add('hidden');
        stepInfo.classList.add('hidden');
        resultsDiv.classList.remove('hidden');

        let correct = 0;

        for (const [key, attempts] of taskAttemptCount.entries()) {
            const task = tasks.find(t => t.id === key);
            const correctText = task.text.trim().toLowerCase();

            if (attempts.some(attempt => attempt.toLowerCase() === correctText)) {
                correct++;
            }
        }

        scoreEl.textContent = `You got ${correct} out of ${taskAttemptCount.size} correct.`;

        const table = document.createElement('table');
        table.border = '1';
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';

        const header = `
            <tr>
                <th>Word</th>
                <th>Attempt 1</th>
                <th>Attempt 2</th>
                <th>Attempt 3</th>
                <th>Attempt 4</th>
            </tr>
        `;
        table.innerHTML = header;

        for (const [key, attempts] of taskAttemptCount.entries()) {
            const task = tasks.find(t => t.id === key);
            const correctText = task.text;

            const paddedAttempts = [...attempts];
            while (paddedAttempts.length < 4) {
                paddedAttempts.push('');
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td onclick="practice('${task.text}')" class="${
                paddedAttempts.every((x) => compare(correctText, x)) ? 'correct' : 'incorrect'
            }">${task.text}/${task.translation}</td>
                <td class="${compare(correctText, paddedAttempts[0]) ? 'correct' : 'incorrect'}">${paddedAttempts[0]}</td>
                <td class="${compare(correctText, paddedAttempts[1]) ? 'correct' : 'incorrect'}">${paddedAttempts[1]}</td>
                <td class="${compare(correctText, paddedAttempts[2]) ? 'correct' : 'incorrect'}">${paddedAttempts[2]}</td>
                <td class="${compare(correctText, paddedAttempts[3]) ? 'correct' : 'incorrect'}">${paddedAttempts[3]}</td>
            `;
            table.appendChild(row);
        }

        mistakeList.innerHTML = '';
        mistakeList.appendChild(table);
    }

    answerForm.addEventListener('submit', (e) => {
        e.preventDefault();

        const currentTask = tasks[currentIndex];
        const key = currentTask.id;
        const userText = textInput.value.trim();
        const isCorrect = compare(userText, currentTask.text);

        if (!taskAttemptCount.has(key)) {
            taskAttemptCount.set(key, []);
        }

        const attempts = taskAttemptCount.get(key);
        attempts.push(userText);
        userAnswers.push({ task: currentTask, userText });

        console.log(userAnswers, isCorrect);

        if (!isCorrect) {
            skipMap.add(key);
        }

        goToNextTask();
    });

    fetch(DATA_URL)
        .then(res => res.json())
        .then(jsonData => {
            shuffle(jsonData);
            const selected = jsonData.slice(0, AMOUNT);

            selected.forEach(item => {
                for (let i = 0; i < 2; i++) {
                    tasks.push({...item, audio: item.armAudio});
                    tasks.push({...item});
                }
            });

            shuffle(tasks);

            answerForm.classList.remove('hidden');
            loadTask(currentIndex);
        })
        .catch(err => {
            stepInfo.textContent = '❌ Failed to load data.';
            console.error(err);
        });

    function compare(text1, text2) {
        return text1?.toLowerCase().trim() === text2?.toLowerCase().trim();
    }

    function practice(phrase) {
        window.open(`./practice.html?phrase=${encodeURIComponent(phrase)}`, '_blank');
    }
</script>
</body>
</html>
