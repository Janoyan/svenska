<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio Practice App</title>
    <style>
        .correct {
            background-color: #d4ff5e;
        }

        .incorrect {
            background-color: #f3a5a5;
        }

        body {
            font-family: sans-serif;
            margin: auto;
            padding: 20px;
        }

        input {
            width: 100%;
            margin: 10px 0;
            padding: 8px;
            font-size: 1em;
        }

        button {
            padding: 10px 20px;
            font-size: 1em;
        }

        .hidden {
            display: none;
        }

        .mistake {
            margin-bottom: 10px;
            background: #ffe0e0;
            padding: 10px;
        }
    </style>
</head>
<body>
<h1>Audio Practice</h1>
<p id="stepInfo">Loading...</p>
<audio id="audio" controls></audio>
<form id="answerForm" class="hidden">
    <label>
        English:
        <input type="text" id="textInput" required>
    </label>
    <button type="submit">Next</button>
</form>

<div id="results" class="hidden">
    <h2>✅ Completed!</h2>
    <p id="score"></p>
    <h3>Mistakes:</h3>
    <div id="mistakeList"></div>
</div>

<script>
    const DATA_URL = `./jsons/second.json?nocache=${Date.now()}`;
    const answerForm = document.getElementById('answerForm');
    const textInput = document.getElementById('textInput');
    const audioEl = document.getElementById('audio');
    const stepInfo = document.getElementById('stepInfo');
    const resultsDiv = document.getElementById('results');
    const scoreEl = document.getElementById('score');
    const mistakeList = document.getElementById('mistakeList');

    let tasks = [];
    let currentIndex = 0;
    let userAnswers = [];
    const playedArms = new Map();

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function loadTask(index) {
        const task = tasks[index];

        // Check if armAudio exists and has not been played yet
        if (task.armAudio && !playedArms.has(task.armAudio)) {
            audioEl.src = task.armAudio;
            playedArms.set(task.armAudio, true)
        } else {
            audioEl.src = task.audio;
        }

        audioEl.play();
        textInput.value = "";
        stepInfo.textContent = `Step ${index + 1} of ${tasks.length}`;
        textInput.focus();
    }


    function showResults() {
        answerForm.classList.add('hidden');
        audioEl.classList.add('hidden');
        stepInfo.classList.add('hidden');
        resultsDiv.classList.remove('hidden');

        let correct = 0;
        const taskHistory = new Map();

        userAnswers.forEach(ans => {
            const key = ans.task.audio;
            const correctText = ans.task.text.trim();
            const userText = ans.userText.trim();
            const isCorrect = userText.toLowerCase() === correctText.toLowerCase();

            if (isCorrect) correct++;

            if (!taskHistory.has(key)) {
                taskHistory.set(key, {
                    task: ans.task,
                    attempts: []
                });
            }

            taskHistory.get(key).attempts.push({
                userText
            });
        });

        scoreEl.textContent = `You got ${correct} out of ${tasks.length} correct.`;

        const table = document.createElement('table');
        table.border = '1';
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';

        const header = `
            <tr>
                <th>Word</th>
                <th>Attempt 1</th>
                <th>Attempt 2</th>
                <th>Attempt 3</th>
            </tr>
        `;
        table.innerHTML = header;

        for (const { task, attempts } of taskHistory.values()) {
            const engAttempts = attempts.map(a => a.userText);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td onclick="practice('${task.text}')" class="${
                compare(task.text, engAttempts[0]) &&
                compare(task.text, engAttempts[1]) &&
                compare(task.text, engAttempts[2])
                    ? 'correct'
                    : 'incorrect'
            }">${task.text}/${task.translation}</td>
                <td class="${compare(task.text, engAttempts[0]) ? 'correct' : 'incorrect'}">${engAttempts[0] || ''}</td>
                <td class="${compare(task.text, engAttempts[1]) ? 'correct' : 'incorrect'}">${engAttempts[1] || ''}</td>
                <td class="${compare(task.text, engAttempts[2]) ? 'correct' : 'incorrect'}">${engAttempts[2] || ''}</td>
            `;
            table.appendChild(row);
        }

        mistakeList.innerHTML = '';
        mistakeList.appendChild(table);
    }

    answerForm.addEventListener('submit', (e) => {
        e.preventDefault();

        userAnswers.push({
            task: tasks[currentIndex],
            userText: textInput.value
        });

        currentIndex++;
        if (currentIndex < tasks.length) {
            loadTask(currentIndex);
        } else {
            showResults();
        }
    });

    fetch(DATA_URL)
        .then(res => res.json())
        .then(jsonData => {
            shuffle(jsonData);
            const selected = jsonData.slice(0, 25);

            const part1 = [];
            const part2 = [];

            selected.forEach(item => {
                part1.push(item);
                for (let i = 0; i < 2; i++) {
                    part2.push({ ...item });
                }
            });

            tasks = part1.concat(shuffle(part2));
            answerForm.classList.remove('hidden');
            loadTask(currentIndex);
        })
        .catch(err => {
            stepInfo.textContent = '❌ Failed to load data.';
            console.error(err);
        });

    function compare(text1, text2) {
        return text1?.toLowerCase().trim() === text2?.toLowerCase().trim();
    }

    function practice(phrase) {
        window.open(`./practice.html?phrase=${encodeURIComponent(phrase)}}`, '_blank');
    }
</script>
</body>
</html>
